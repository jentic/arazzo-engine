name: Arazzo Engine CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      generator: ${{ steps.filter.outputs.generator }}
      runner:    ${{ steps.filter.outputs.runner }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            generator:
              - 'generator/**'
            runner:
              - 'runner/**'  

  generator:
    name: generator
    runs-on: ubuntu-latest
    needs: detect-changes
    strategy:
      matrix:
        python-version: [ "3.11", "3.12", "3.13" ]
    steps:
      # Always run at least one step so the job posts a success check
      - name: sentinel
        run: echo "generator check"

      - uses: actions/checkout@v4

      - name: Test generator
        if: ${{ needs.detect-changes.outputs.generator == 'true' }}
        uses: ./.github/actions/arazzo-generator/test/action.yml
        with:
          python-version: ${{ matrix.python-version }}

  runner:
    name: runner
    runs-on: ubuntu-latest
    needs: detect-changes
    strategy:
      matrix:
        python-version: [ "3.11", "3.12", "3.13" ]
    steps:
      # Always run at least one step so the job posts a success check
      - name: sentinel
        run: echo "runner check"

      - uses: actions/checkout@v4

      - name: Test runner
        if: ${{ needs.detect-changes.outputs.runner == 'true' }}
        uses: ./.github/actions/arazzo-runner/test/action.yml
        with:
          python-version: ${{ matrix.python-version }}

      - name: Static Analysis runner
        if: ${{ needs.detect-changes.outputs.runner == 'true' && matrix.python-version == '3.11' }}
        uses: ./.github/actions/arazzo-runner/static-analysis/action.yml

